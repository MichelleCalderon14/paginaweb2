{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n    r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n    d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n// src/app/features/docentes/docente-calificaciones.page.ts\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { forkJoin } from 'rxjs';\nlet DocenteCalificacionesPage = class DocenteCalificacionesPage {\n  constructor(alumnosSrv, auth, evalSrv, notasSrv) {\n    this.alumnosSrv = alumnosSrv;\n    this.auth = auth;\n    this.evalSrv = evalSrv;\n    this.notasSrv = notasSrv;\n    this.alumnos = [];\n    this.evaluacionesVisibles = [];\n    this.cargando = false;\n    this.error = false;\n  }\n  ngOnInit() {\n    const idDocente = this.getDocenteId();\n    this.cargarDatos(idDocente);\n  }\n  /** Igual que antes: mapear usuario â†’ id_docente */\n  getDocenteId() {\n    const usuario = this.auth.currentUser;\n    const userName = usuario?.username?.toLowerCase() || '';\n    if (userName === 'mariacabrera') return 1;\n    if (userName === 'carlos molina') return 2;\n    if (userName === 'luispacheco') return 3;\n    console.warn('getDocenteId: usuario no mapeado, usando 1 por defecto');\n    return 1;\n  }\n  /** Carga alumnos, evaluaciones y notas y arma la matriz */\n  cargarDatos(idDocente) {\n    this.cargando = true;\n    this.error = false;\n    forkJoin({\n      alumnos: this.alumnosSrv.listarPorDocente(idDocente),\n      evaluaciones: this.evalSrv.listar(),\n      notas: this.notasSrv.listar()\n    }).subscribe({\n      next: ({\n        alumnos,\n        evaluaciones,\n        notas\n      }) => {\n        // ðŸ”§ si quieres filtrar por curso, ajusta aquÃ­.\n        // Por ahora, muestro todas las evaluaciones que tengan al menos una nota\n        const idsEvaluacionesConNotas = new Set((notas || []).map(n => n.evaluacion?.id_evaluacion));\n        this.evaluacionesVisibles = (evaluaciones || []).filter(ev => idsEvaluacionesConNotas.has(ev.id_evaluacion));\n        // Construir estructura alumno â†’ { evaluacion â†’ nota }\n        this.alumnos = (alumnos || []).map(a => {\n          const notasAlumno = (notas || []).filter(n => n.alumno?.id_alumno === a.id_alumno);\n          const mapaNotas = {};\n          this.evaluacionesVisibles.forEach(ev => {\n            const n = notasAlumno.find(x => x.evaluacion?.id_evaluacion === ev.id_evaluacion);\n            mapaNotas[ev.id_evaluacion] = {\n              valor: n ? n.calificacion : null,\n              id_nota: n?.id_nota\n            };\n          });\n          const ext = {\n            ...a,\n            notas: mapaNotas,\n            promedio: null,\n            estado: ''\n          };\n          this.recalcular(ext);\n          return ext;\n        });\n        this.cargando = false;\n      },\n      error: err => {\n        console.error('[DocenteCalificaciones] error', err);\n        this.error = true;\n        this.cargando = false;\n      }\n    });\n  }\n  /** Recalcula promedio y estado de un alumno */\n  recalcular(a) {\n    const valores = Object.values(a.notas).map(c => c.valor)\n    // ðŸ‘‡ quitamos la comparaciÃ³n con '' (string)\n    .filter(v => v !== null && v !== undefined);\n    if (!valores.length) {\n      a.promedio = null;\n      a.estado = '';\n      return;\n    }\n    const suma = valores.reduce((acc, v) => acc + Number(v), 0);\n    const prom = suma / valores.length;\n    a.promedio = Number(prom.toFixed(2));\n    a.estado = prom >= 7 ? 'Aprueba' : 'Reprueba';\n  }\n  /** Solo actualiza notas que ya existen (no crea nuevas) */\n  guardarCambios() {\n    const peticiones = [];\n    for (const a of this.alumnos) {\n      for (const ev of this.evaluacionesVisibles) {\n        const celda = a.notas[ev.id_evaluacion];\n        if (!celda?.id_nota) {\n          // no hay nota en BD â†’ NO creamos nada, solo ignoramos\n          continue;\n        }\n        // ðŸ‘‡ tambiÃ©n sin comparar contra ''\n        if (celda.valor === null || celda.valor === undefined) {\n          // si quisieras poder borrar la nota, aquÃ­ podrÃ­as manejarlo\n          continue;\n        }\n        peticiones.push(this.notasSrv.actualizar(celda.id_nota, {\n          calificacion: Number(celda.valor)\n        }));\n      }\n    }\n    if (!peticiones.length) {\n      alert('No hay cambios para guardar.');\n      return;\n    }\n    forkJoin(peticiones).subscribe({\n      next: () => {\n        alert('Notas actualizadas correctamente âœ”');\n      },\n      error: err => {\n        console.error(err);\n        alert('Error al actualizar notas.');\n      }\n    });\n  }\n};\nDocenteCalificacionesPage = __decorate([Component({\n  standalone: true,\n  selector: 'app-docente-calificaciones',\n  imports: [CommonModule, FormsModule],\n  template: `\n  <div class=\"container mt-4\">\n\n    <h2 class=\"mb-3\">Registro de Calificaciones</h2>\n\n    <div *ngIf=\"cargando\" class=\"alert alert-info\">Cargando alumnos y notasâ€¦</div>\n    <div *ngIf=\"error\" class=\"alert alert-danger\">No se pudieron cargar los datos.</div>\n\n    <ng-container *ngIf=\"!cargando && !error\">\n\n      <table class=\"table table-bordered table-striped text-center\" *ngIf=\"alumnos.length; else sinAlumnos\">\n        <thead class=\"table-primary\">\n          <tr>\n            <th>Estudiante</th>\n            <th *ngFor=\"let ev of evaluacionesVisibles\">\n              {{ ev.nombre }}\n              <br>\n              <small class=\"text-muted\">{{ ev.tipo }}</small>\n            </th>\n            <th>Promedio</th>\n            <th>Estado</th>\n          </tr>\n        </thead>\n\n        <tbody>\n          <tr *ngFor=\"let a of alumnos\">\n            <td>{{ a.apellidos }} {{ a.nombres }}</td>\n\n            <!-- celdas de cada evaluaciÃ³n -->\n            <td *ngFor=\"let ev of evaluacionesVisibles\">\n              <input type=\"number\"\n                     class=\"form-control\"\n                     [(ngModel)]=\"a.notas[ev.id_evaluacion].valor\"\n                     (ngModelChange)=\"recalcular(a)\"\n                     min=\"0\" max=\"10\" step=\"0.1\">\n            </td>\n\n            <td>{{ a.promedio }}</td>\n\n            <td [ngClass]=\"a.estado === 'Aprueba'\n                           ? 'text-success fw-bold'\n                           : 'text-danger fw-bold'\">\n              {{ a.estado }}\n            </td>\n          </tr>\n        </tbody>\n      </table>\n\n      <ng-template #sinAlumnos>\n        <div class=\"alert alert-warning\">\n          No hay alumnos registrados para este docente.\n        </div>\n      </ng-template>\n\n      <button class=\"btn btn-success\"\n              (click)=\"guardarCambios()\"\n              [disabled]=\"!alumnos.length\">\n        Guardar cambios\n      </button>\n\n    </ng-container>\n\n  </div>\n  `\n})], DocenteCalificacionesPage);\nexport { DocenteCalificacionesPage };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}