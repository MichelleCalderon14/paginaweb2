{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../alumnos/alumnos.service\";\nimport * as i2 from \"../../shared/auth.service\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nfunction DocenteCalificacionesPage_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 6);\n    i0.…µ…µtext(1, \"Cargando alumnos\\u2026\");\n    i0.…µ…µelementEnd();\n  }\n}\nfunction DocenteCalificacionesPage_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 7);\n    i0.…µ…µtext(1, \"No se pudieron cargar los datos.\");\n    i0.…µ…µelementEnd();\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_table_9_th_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"th\");\n    i0.…µ…µtext(1);\n    i0.…µ…µelementEnd();\n  }\n  if (rf & 2) {\n    const t_r3 = ctx.$implicit;\n    i0.…µ…µadvance();\n    i0.…µ…µtextInterpolate1(\" \", t_r3, \" \");\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_table_9_tr_11_td_3_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.…µ…µgetCurrentView();\n    i0.…µ…µelementStart(0, \"td\")(1, \"input\", 19);\n    i0.…µ…µtwoWayListener(\"ngModelChange\", function DocenteCalificacionesPage_ng_container_5_table_9_tr_11_td_3_Template_input_ngModelChange_1_listener($event) {\n      const j_r5 = i0.…µ…µrestoreView(_r4).index;\n      const a_r6 = i0.…µ…µnextContext().$implicit;\n      i0.…µ…µtwoWayBindingSet(a_r6.notas[j_r5], $event) || (a_r6.notas[j_r5] = $event);\n      return i0.…µ…µresetView($event);\n    });\n    i0.…µ…µlistener(\"ngModelChange\", function DocenteCalificacionesPage_ng_container_5_table_9_tr_11_td_3_Template_input_ngModelChange_1_listener() {\n      i0.…µ…µrestoreView(_r4);\n      const a_r6 = i0.…µ…µnextContext().$implicit;\n      const ctx_r1 = i0.…µ…µnextContext(3);\n      return i0.…µ…µresetView(ctx_r1.onNotaChange(a_r6));\n    });\n    i0.…µ…µelementEnd()();\n  }\n  if (rf & 2) {\n    const j_r5 = ctx.index;\n    const a_r6 = i0.…µ…µnextContext().$implicit;\n    i0.…µ…µadvance();\n    i0.…µ…µtwoWayProperty(\"ngModel\", a_r6.notas[j_r5]);\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_table_9_tr_11_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"tr\")(1, \"td\", 17);\n    i0.…µ…µtext(2);\n    i0.…µ…µelementEnd();\n    i0.…µ…µtemplate(3, DocenteCalificacionesPage_ng_container_5_table_9_tr_11_td_3_Template, 2, 1, \"td\", 16);\n    i0.…µ…µelementStart(4, \"td\");\n    i0.…µ…µtext(5);\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(6, \"td\", 18);\n    i0.…µ…µtext(7);\n    i0.…µ…µelementEnd()();\n  }\n  if (rf & 2) {\n    const a_r6 = ctx.$implicit;\n    const ctx_r1 = i0.…µ…µnextContext(3);\n    i0.…µ…µadvance(2);\n    i0.…µ…µtextInterpolate2(\" \", a_r6.apellidos, \" \", a_r6.nombres, \" \");\n    i0.…µ…µadvance();\n    i0.…µ…µproperty(\"ngForOf\", ctx_r1.tareas);\n    i0.…µ…µadvance(2);\n    i0.…µ…µtextInterpolate1(\" \", a_r6.promedio !== null ? a_r6.promedio : \"\\u2014\", \" \");\n    i0.…µ…µadvance();\n    i0.…µ…µproperty(\"ngClass\", a_r6.estado === \"Aprueba\" ? \"text-success fw-bold\" : a_r6.estado === \"Reprueba\" ? \"text-danger fw-bold\" : \"\");\n    i0.…µ…µadvance();\n    i0.…µ…µtextInterpolate1(\" \", a_r6.estado || \"\\u2014\", \" \");\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_table_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"table\", 14)(1, \"thead\", 15)(2, \"tr\")(3, \"th\");\n    i0.…µ…µtext(4, \"Estudiante\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtemplate(5, DocenteCalificacionesPage_ng_container_5_table_9_th_5_Template, 2, 1, \"th\", 16);\n    i0.…µ…µelementStart(6, \"th\");\n    i0.…µ…µtext(7, \"Promedio\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(8, \"th\");\n    i0.…µ…µtext(9, \"Estado\");\n    i0.…µ…µelementEnd()()();\n    i0.…µ…µelementStart(10, \"tbody\");\n    i0.…µ…µtemplate(11, DocenteCalificacionesPage_ng_container_5_table_9_tr_11_Template, 8, 6, \"tr\", 16);\n    i0.…µ…µelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.…µ…µnextContext(2);\n    i0.…µ…µadvance(5);\n    i0.…µ…µproperty(\"ngForOf\", ctx_r1.tareas);\n    i0.…µ…µadvance(6);\n    i0.…µ…µproperty(\"ngForOf\", ctx_r1.alumnos);\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_ng_template_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 20);\n    i0.…µ…µtext(1, \" No hay alumnos registrados para este docente. \");\n    i0.…µ…µelementEnd();\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.…µ…µgetCurrentView();\n    i0.…µ…µelementContainerStart(0);\n    i0.…µ…µelementStart(1, \"div\", 8)(2, \"div\", 9)(3, \"button\", 10);\n    i0.…µ…µlistener(\"click\", function DocenteCalificacionesPage_ng_container_5_Template_button_click_3_listener() {\n      i0.…µ…µrestoreView(_r1);\n      const ctx_r1 = i0.…µ…µnextContext();\n      return i0.…µ…µresetView(ctx_r1.agregarTarea());\n    });\n    i0.…µ…µtext(4, \" Crear nueva tarea \");\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(5, \"button\", 11);\n    i0.…µ…µlistener(\"click\", function DocenteCalificacionesPage_ng_container_5_Template_button_click_5_listener() {\n      i0.…µ…µrestoreView(_r1);\n      const ctx_r1 = i0.…µ…µnextContext();\n      return i0.…µ…µresetView(ctx_r1.guardarCalificaciones());\n    });\n    i0.…µ…µtext(6, \" Guardar cambios \");\n    i0.…µ…µelementEnd()();\n    i0.…µ…µelementStart(7, \"small\", 12);\n    i0.…µ…µtext(8, \" Por defecto tienes Tarea 1 y Tarea 2; puedes a\\u00F1adir m\\u00E1s tareas con el bot\\u00F3n. \");\n    i0.…µ…µelementEnd()();\n    i0.…µ…µtemplate(9, DocenteCalificacionesPage_ng_container_5_table_9_Template, 12, 2, \"table\", 13)(10, DocenteCalificacionesPage_ng_container_5_ng_template_10_Template, 2, 0, \"ng-template\", null, 0, i0.…µ…µtemplateRefExtractor);\n    i0.…µ…µelementContainerEnd();\n  }\n  if (rf & 2) {\n    const sinAlumnos_r7 = i0.…µ…µreference(11);\n    const ctx_r1 = i0.…µ…µnextContext();\n    i0.…µ…µadvance(9);\n    i0.…µ…µproperty(\"ngIf\", ctx_r1.alumnos.length)(\"ngIfElse\", sinAlumnos_r7);\n  }\n}\nexport let DocenteCalificacionesPage = /*#__PURE__*/(() => {\n  var _staticBlock;\n  class DocenteCalificacionesPage {\n    constructor(alumnosSrv, auth) {\n      this.alumnosSrv = alumnosSrv;\n      this.auth = auth;\n      this.tareas = ['Tarea 1', 'Tarea 2'];\n      this.alumnos = [];\n      this.cargando = false;\n      this.error = false;\n      this.docenteId = 0;\n    }\n    ngOnInit() {\n      this.docenteId = this.getDocenteId();\n      this.cargarAlumnos(this.docenteId);\n    }\n    // üîπ Clave en localStorage\n    getStorageKey(idDocente) {\n      return `calif.docente.${idDocente}`;\n    }\n    /** Mapea usuario ‚Üí id_docente (igual que antes) */\n    getDocenteId() {\n      const usuario = this.auth.currentUser;\n      const userName = usuario?.username?.toLowerCase() || '';\n      if (userName === 'mariacabrera') return 1;\n      if (userName === 'carlos molina') return 2;\n      if (userName === 'luispacheco') return 3;\n      console.warn('getDocenteId: usuario no mapeado, usando 1 por defecto');\n      return 1;\n    }\n    /** Carga los alumnos y luego intenta restaurar notas desde localStorage */\n    cargarAlumnos(idDocente) {\n      this.cargando = true;\n      this.error = false;\n      this.alumnosSrv.listarPorDocente(idDocente).subscribe({\n        next: lista => {\n          const baseNotas = this.tareas.map(() => null);\n          this.alumnos = (lista || []).map(a => ({\n            ...a,\n            notas: [...baseNotas],\n            promedio: null,\n            estado: ''\n          }));\n          this.cargando = false;\n          // üëá Despu√©s de tener alumnos, intentamos leer lo guardado\n          this.cargarDesdeStorage();\n        },\n        error: err => {\n          console.error('[DocenteCalificaciones] error cargando alumnos', err);\n          this.error = true;\n          this.cargando = false;\n        }\n      });\n    }\n    /** Lee tareas y notas desde localStorage (si existen) */\n    cargarDesdeStorage() {\n      const raw = localStorage.getItem(this.getStorageKey(this.docenteId));\n      if (!raw) return;\n      try {\n        const data = JSON.parse(raw);\n        if (data.tareas && Array.isArray(data.tareas) && data.tareas.length) {\n          this.tareas = [...data.tareas];\n        }\n        if (data.notasPorAlumno) {\n          for (const a of this.alumnos) {\n            const notasGuardadas = data.notasPorAlumno[a.id_alumno];\n            if (Array.isArray(notasGuardadas)) {\n              // Ajustamos la longitud al n√∫mero de tareas actual\n              const notas = [];\n              for (let i = 0; i < this.tareas.length; i++) {\n                notas[i] = i < notasGuardadas.length ? notasGuardadas[i] : null;\n              }\n              a.notas = notas;\n              this.recalcular(a);\n            }\n          }\n        }\n      } catch (e) {\n        console.warn('No se pudo parsear calificaciones del storage', e);\n      }\n    }\n    /** Guarda TODAS las notas del docente en localStorage */\n    guardarEnStorage() {\n      const notasPorAlumno = {};\n      for (const a of this.alumnos) {\n        notasPorAlumno[a.id_alumno] = [...a.notas];\n      }\n      const data = {\n        tareas: [...this.tareas],\n        notasPorAlumno\n      };\n      localStorage.setItem(this.getStorageKey(this.docenteId), JSON.stringify(data));\n    }\n    /** Bot√≥n \"Guardar cambios\" */\n    guardarCalificaciones() {\n      this.guardarEnStorage();\n      alert('Calificaciones guardadas en este equipo ‚úî');\n    }\n    /** Agrega una nueva tarea (columna) para todos los alumnos */\n    agregarTarea() {\n      const num = this.tareas.length + 1;\n      const nombre = `Tarea ${num}`;\n      this.tareas.push(nombre);\n      this.alumnos.forEach(a => {\n        a.notas.push(null);\n        this.recalcular(a);\n      });\n      this.guardarEnStorage();\n    }\n    /** Cuando cambia una nota */\n    onNotaChange(a) {\n      this.recalcular(a);\n      this.guardarEnStorage();\n    }\n    /** Recalcula promedio y estado de un alumno */\n    recalcular(a) {\n      const valores = a.notas.filter(v => v !== null && v !== undefined);\n      if (!valores.length) {\n        a.promedio = null;\n        a.estado = '';\n        return;\n      }\n      const suma = valores.reduce((acc, v) => acc + Number(v), 0);\n      const prom = suma / valores.length;\n      a.promedio = Number(prom.toFixed(2));\n      a.estado = prom >= 7 ? 'Aprueba' : 'Reprueba';\n    }\n    static #_ = _staticBlock = () => (this.…µfac = function DocenteCalificacionesPage_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || DocenteCalificacionesPage)(i0.…µ…µdirectiveInject(i1.AlumnosService), i0.…µ…µdirectiveInject(i2.AuthService));\n    }, this.…µcmp = /*@__PURE__*/i0.…µ…µdefineComponent({\n      type: DocenteCalificacionesPage,\n      selectors: [[\"app-docente-calificaciones\"]],\n      decls: 6,\n      vars: 3,\n      consts: [[\"sinAlumnos\", \"\"], [1, \"container\", \"mt-4\"], [1, \"mb-3\"], [\"class\", \"alert alert-info\", 4, \"ngIf\"], [\"class\", \"alert alert-danger\", 4, \"ngIf\"], [4, \"ngIf\"], [1, \"alert\", \"alert-info\"], [1, \"alert\", \"alert-danger\"], [1, \"d-flex\", \"justify-content-between\", \"align-items-center\", \"mb-3\", \"flex-wrap\", \"gap-2\"], [1, \"d-flex\", \"gap-2\"], [1, \"btn\", \"btn-sm\", \"btn-outline-primary\", 3, \"click\"], [1, \"btn\", \"btn-sm\", \"btn-success\", 3, \"click\"], [1, \"text-muted\"], [\"class\", \"table table-bordered table-striped text-center\", 4, \"ngIf\", \"ngIfElse\"], [1, \"table\", \"table-bordered\", \"table-striped\", \"text-center\"], [1, \"table-primary\"], [4, \"ngFor\", \"ngForOf\"], [1, \"text-start\"], [3, \"ngClass\"], [\"type\", \"number\", \"min\", \"0\", \"max\", \"10\", \"step\", \"0.1\", 1, \"form-control\", \"form-control-sm\", 3, \"ngModelChange\", \"ngModel\"], [1, \"alert\", \"alert-warning\"]],\n      template: function DocenteCalificacionesPage_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.…µ…µelementStart(0, \"div\", 1)(1, \"h2\", 2);\n          i0.…µ…µtext(2, \"Registro de Calificaciones\");\n          i0.…µ…µelementEnd();\n          i0.…µ…µtemplate(3, DocenteCalificacionesPage_div_3_Template, 2, 0, \"div\", 3)(4, DocenteCalificacionesPage_div_4_Template, 2, 0, \"div\", 4)(5, DocenteCalificacionesPage_ng_container_5_Template, 12, 2, \"ng-container\", 5);\n          i0.…µ…µelementEnd();\n        }\n        if (rf & 2) {\n          i0.…µ…µadvance(3);\n          i0.…µ…µproperty(\"ngIf\", ctx.cargando);\n          i0.…µ…µadvance();\n          i0.…µ…µproperty(\"ngIf\", ctx.error);\n          i0.…µ…µadvance();\n          i0.…µ…µproperty(\"ngIf\", !ctx.cargando && !ctx.error);\n        }\n      },\n      dependencies: [CommonModule, i3.NgClass, i3.NgForOf, i3.NgIf, FormsModule, i4.DefaultValueAccessor, i4.NumberValueAccessor, i4.NgControlStatus, i4.MinValidator, i4.MaxValidator, i4.NgModel],\n      encapsulation: 2\n    }));\n  }\n  _staticBlock();\n  return DocenteCalificacionesPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}