{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { forkJoin } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../alumnos/alumnos.service\";\nimport * as i2 from \"../../shared/auth.service\";\nimport * as i3 from \"../evaluaciones/evaluaciones.service\";\nimport * as i4 from \"../notas/notas.service\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/forms\";\nfunction DocenteCalificacionesPage_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 6);\n    i0.ɵɵtext(1, \"Cargando alumnos y notas\\u2026\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction DocenteCalificacionesPage_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 7);\n    i0.ɵɵtext(1, \"No se pudieron cargar los datos.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_table_1_th_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"th\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelement(2, \"br\");\n    i0.ɵɵelementStart(3, \"small\", 13);\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ev_r2 = ctx.$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", ev_r2.nombre, \" \");\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(ev_r2.tipo);\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_table_1_tr_11_td_3_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"td\")(1, \"input\", 15);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function DocenteCalificacionesPage_ng_container_5_table_1_tr_11_td_3_Template_input_ngModelChange_1_listener($event) {\n      const ev_r4 = i0.ɵɵrestoreView(_r3).$implicit;\n      const a_r5 = i0.ɵɵnextContext().$implicit;\n      i0.ɵɵtwoWayBindingSet(a_r5.notas[ev_r4.id_evaluacion].valor, $event) || (a_r5.notas[ev_r4.id_evaluacion].valor = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵlistener(\"ngModelChange\", function DocenteCalificacionesPage_ng_container_5_table_1_tr_11_td_3_Template_input_ngModelChange_1_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const a_r5 = i0.ɵɵnextContext().$implicit;\n      const ctx_r5 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r5.recalcular(a_r5));\n    });\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ev_r4 = ctx.$implicit;\n    const a_r5 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtwoWayProperty(\"ngModel\", a_r5.notas[ev_r4.id_evaluacion].valor);\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_table_1_tr_11_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(3, DocenteCalificacionesPage_ng_container_5_table_1_tr_11_td_3_Template, 2, 1, \"td\", 12);\n    i0.ɵɵelementStart(4, \"td\");\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"td\", 14);\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const a_r5 = ctx.$implicit;\n    const ctx_r5 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate2(\"\", a_r5.apellidos, \" \", a_r5.nombres);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r5.evaluacionesVisibles);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(a_r5.promedio);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngClass\", a_r5.estado === \"Aprueba\" ? \"text-success fw-bold\" : \"text-danger fw-bold\");\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", a_r5.estado, \" \");\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_table_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"table\", 10)(1, \"thead\", 11)(2, \"tr\")(3, \"th\");\n    i0.ɵɵtext(4, \"Estudiante\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(5, DocenteCalificacionesPage_ng_container_5_table_1_th_5_Template, 5, 2, \"th\", 12);\n    i0.ɵɵelementStart(6, \"th\");\n    i0.ɵɵtext(7, \"Promedio\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"th\");\n    i0.ɵɵtext(9, \"Estado\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(10, \"tbody\");\n    i0.ɵɵtemplate(11, DocenteCalificacionesPage_ng_container_5_table_1_tr_11_Template, 8, 6, \"tr\", 12);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r5 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r5.evaluacionesVisibles);\n    i0.ɵɵadvance(6);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r5.alumnos);\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_ng_template_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 16);\n    i0.ɵɵtext(1, \" No hay alumnos registrados para este docente. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction DocenteCalificacionesPage_ng_container_5_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵtemplate(1, DocenteCalificacionesPage_ng_container_5_table_1_Template, 12, 2, \"table\", 8)(2, DocenteCalificacionesPage_ng_container_5_ng_template_2_Template, 2, 0, \"ng-template\", null, 0, i0.ɵɵtemplateRefExtractor);\n    i0.ɵɵelementStart(4, \"button\", 9);\n    i0.ɵɵlistener(\"click\", function DocenteCalificacionesPage_ng_container_5_Template_button_click_4_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r5 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r5.guardarCambios());\n    });\n    i0.ɵɵtext(5, \" Guardar cambios \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const sinAlumnos_r7 = i0.ɵɵreference(3);\n    const ctx_r5 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r5.alumnos.length)(\"ngIfElse\", sinAlumnos_r7);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"disabled\", !ctx_r5.alumnos.length);\n  }\n}\nexport let DocenteCalificacionesPage = /*#__PURE__*/(() => {\n  var _staticBlock;\n  class DocenteCalificacionesPage {\n    constructor(alumnosSrv, auth, evalSrv, notasSrv) {\n      this.alumnosSrv = alumnosSrv;\n      this.auth = auth;\n      this.evalSrv = evalSrv;\n      this.notasSrv = notasSrv;\n      this.alumnos = [];\n      this.evaluacionesVisibles = [];\n      this.cargando = false;\n      this.error = false;\n    }\n    ngOnInit() {\n      const idDocente = this.getDocenteId();\n      this.cargarDatos(idDocente);\n    }\n    /** Igual que antes: mapear usuario → id_docente */\n    getDocenteId() {\n      const usuario = this.auth.currentUser;\n      const userName = usuario?.username?.toLowerCase() || '';\n      if (userName === 'mariacabrera') return 1;\n      if (userName === 'carlos molina') return 2;\n      if (userName === 'luispacheco') return 3;\n      console.warn('getDocenteId: usuario no mapeado, usando 1 por defecto');\n      return 1;\n    }\n    /** Carga alumnos, evaluaciones y notas y arma la matriz */\n    cargarDatos(idDocente) {\n      this.cargando = true;\n      this.error = false;\n      forkJoin({\n        alumnos: this.alumnosSrv.listarPorDocente(idDocente),\n        evaluaciones: this.evalSrv.listar(),\n        notas: this.notasSrv.listar()\n      }).subscribe({\n        next: ({\n          alumnos,\n          evaluaciones,\n          notas\n        }) => {\n          const listaNotas = notas || [];\n          const listaEval = evaluaciones || [];\n          const idsEvaluacionesConNotas = new Set(listaNotas.map(n => n.evaluacion?.id_evaluacion));\n          this.evaluacionesVisibles = listaEval.filter(ev => idsEvaluacionesConNotas.has(ev.id_evaluacion));\n          this.alumnos = (alumnos || []).map(a => {\n            const notasAlumno = listaNotas.filter(n => n.alumno?.id_alumno === a.id_alumno);\n            const mapaNotas = {};\n            this.evaluacionesVisibles.forEach(ev => {\n              const n = notasAlumno.find(x => x.evaluacion?.id_evaluacion === ev.id_evaluacion);\n              mapaNotas[ev.id_evaluacion] = {\n                valor: n ? n.calificacion : null,\n                id_nota: n?.id_nota\n              };\n            });\n            const ext = {\n              ...a,\n              notas: mapaNotas,\n              promedio: null,\n              estado: ''\n            };\n            this.recalcular(ext);\n            return ext;\n          });\n          this.cargando = false;\n        },\n        error: err => {\n          console.error('[DocenteCalificaciones] error', err);\n          this.error = true;\n          this.cargando = false;\n        }\n      });\n    }\n    /** Recalcula promedio y estado de un alumno */\n    recalcular(a) {\n      const valores = Object.values(a.notas).map(c => c.valor).filter(v => v !== null && v !== undefined);\n      if (!valores.length) {\n        a.promedio = null;\n        a.estado = '';\n        return;\n      }\n      const suma = valores.reduce((acc, v) => acc + Number(v), 0);\n      const prom = suma / valores.length;\n      a.promedio = Number(prom.toFixed(2));\n      a.estado = prom >= 7 ? 'Aprueba' : 'Reprueba';\n    }\n    /** Solo actualiza notas que ya existen (no crea nuevas) */\n    guardarCambios() {\n      const peticiones = [];\n      for (const a of this.alumnos) {\n        for (const ev of this.evaluacionesVisibles) {\n          const celda = a.notas[ev.id_evaluacion];\n          if (!celda?.id_nota) {\n            continue;\n          }\n          if (celda.valor === null || celda.valor === undefined) {\n            continue;\n          }\n          peticiones.push(this.notasSrv.actualizar(celda.id_nota, {\n            calificacion: Number(celda.valor)\n          }));\n        }\n      }\n      if (!peticiones.length) {\n        alert('No hay cambios para guardar.');\n        return;\n      }\n      forkJoin(peticiones).subscribe({\n        next: () => {\n          alert('Notas actualizadas correctamente ✔');\n        },\n        error: err => {\n          console.error(err);\n          alert('Error al actualizar notas.');\n        }\n      });\n    }\n    static #_ = _staticBlock = () => (this.ɵfac = function DocenteCalificacionesPage_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || DocenteCalificacionesPage)(i0.ɵɵdirectiveInject(i1.AlumnosService), i0.ɵɵdirectiveInject(i2.AuthService), i0.ɵɵdirectiveInject(i3.EvaluacionesService), i0.ɵɵdirectiveInject(i4.NotasService));\n    }, this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: DocenteCalificacionesPage,\n      selectors: [[\"app-docente-calificaciones\"]],\n      decls: 6,\n      vars: 3,\n      consts: [[\"sinAlumnos\", \"\"], [1, \"container\", \"mt-4\"], [1, \"mb-3\"], [\"class\", \"alert alert-info\", 4, \"ngIf\"], [\"class\", \"alert alert-danger\", 4, \"ngIf\"], [4, \"ngIf\"], [1, \"alert\", \"alert-info\"], [1, \"alert\", \"alert-danger\"], [\"class\", \"table table-bordered table-striped text-center\", 4, \"ngIf\", \"ngIfElse\"], [1, \"btn\", \"btn-success\", 3, \"click\", \"disabled\"], [1, \"table\", \"table-bordered\", \"table-striped\", \"text-center\"], [1, \"table-primary\"], [4, \"ngFor\", \"ngForOf\"], [1, \"text-muted\"], [3, \"ngClass\"], [\"type\", \"number\", \"min\", \"0\", \"max\", \"10\", \"step\", \"0.1\", 1, \"form-control\", 3, \"ngModelChange\", \"ngModel\"], [1, \"alert\", \"alert-warning\"]],\n      template: function DocenteCalificacionesPage_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵelementStart(0, \"div\", 1)(1, \"h2\", 2);\n          i0.ɵɵtext(2, \"Registro de Calificaciones\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵtemplate(3, DocenteCalificacionesPage_div_3_Template, 2, 0, \"div\", 3)(4, DocenteCalificacionesPage_div_4_Template, 2, 0, \"div\", 4)(5, DocenteCalificacionesPage_ng_container_5_Template, 6, 3, \"ng-container\", 5);\n          i0.ɵɵelementEnd();\n        }\n        if (rf & 2) {\n          i0.ɵɵadvance(3);\n          i0.ɵɵproperty(\"ngIf\", ctx.cargando);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", ctx.error);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", !ctx.cargando && !ctx.error);\n        }\n      },\n      dependencies: [CommonModule, i5.NgClass, i5.NgForOf, i5.NgIf, FormsModule, i6.DefaultValueAccessor, i6.NumberValueAccessor, i6.NgControlStatus, i6.MinValidator, i6.MaxValidator, i6.NgModel],\n      encapsulation: 2\n    }));\n  }\n  _staticBlock();\n  return DocenteCalificacionesPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}